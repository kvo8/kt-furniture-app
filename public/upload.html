<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• Upload File</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .container { max-width: 800px; }
        .upload-section { margin-bottom: 30px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; background-color: #fdfdfd; }
        .upload-section h3 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 15px; }
        .upload-btn { background-color: #007bff; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: inline-block; transition: background-color 0.2s; }
        .upload-btn:hover { background-color: #0056b3; }
        .upload-btn:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        .status-box { margin-top: 15px; }
        .status-box .label { font-weight: bold; }
        .result-textarea { width: 100%; box-sizing: border-box; height: 120px; font-family: monospace; margin-top: 10px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        .copy-btn { margin-top: 5px; padding: 5px 10px; font-size: 12px; cursor: pointer; }
        /* GHI CH√ö: B·ªï sung style cho ph·∫ßn hi·ªÉn th·ªã tr·∫°ng th√°i chi ti·∫øt */
        .file-status-list { text-align: left; font-size: 14px; margin-top: 10px; }
        .file-status-list div { padding: 4px 0; }
        .file-status-list .success { color: #28a745; }
        .file-status-list .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>C√¥ng C·ª• Upload File L√™n Cloud Storage</h1>
            <p>S·ª≠ d·ª•ng trang n√†y ƒë·ªÉ t·∫£i file l√™n v√† sao ch√©p danh s√°ch link ƒë·ªÉ d√°n v√†o form s·∫£n ph·∫©m.</p>
        </header>

        <div class="upload-section">
            <h3>1. H√¨nh ·∫£nh s·∫£n ph·∫©m (T·ªëi ƒëa 5 file)</h3>
            <div class="upload-area">
                <input type="file" id="image-input" accept="image/*" multiple style="display: none;">
                <label for="image-input" class="upload-btn">Ch·ªçn ·∫¢nh</label>
                <div id="image-files-list" class="file-status-list"></div>
            </div>
            <button class="upload-btn" id="upload-images-btn" disabled>T·∫£i ·∫¢nh L√™n</button>
            <div class="status-box" id="image-status" style="display: none;">
                <p class="label">Danh s√°ch URL ·∫£nh (sao ch√©p v√† d√°n v√†o form):</p>
                <textarea id="image-urls" class="result-textarea" readonly></textarea>
                <button class="copy-btn" data-target="image-urls">Sao ch√©p</button>
            </div>
        </div>

        <div class="upload-section">
            <h3>2. B·∫£n v·∫Ω (PDF, T·ªëi ƒëa 5 file)</h3>
            <div class="upload-area">
                <input type="file" id="drawing-input" accept=".pdf" multiple style="display: none;">
                <label for="drawing-input" class="upload-btn">Ch·ªçn File PDF</label>
                <div id="drawing-files-list" class="file-status-list"></div>
            </div>
            <button class="upload-btn" id="upload-drawings-btn" disabled>T·∫£i B·∫£n V·∫Ω L√™n</button>
            <div class="status-box" id="drawing-status" style="display: none;">
                <p class="label">Danh s√°ch URL b·∫£n v·∫Ω (sao ch√©p v√† d√°n v√†o form):</p>
                <textarea id="drawing-urls" class="result-textarea" readonly></textarea>
                <button class="copy-btn" data-target="drawing-urls">Sao ch√©p</button>
            </div>
        </div>

        <div class="upload-section">
            <h3>3. V·∫≠t t∆∞ (Word, Excel, PDF, T·ªëi ƒëa 5 file)</h3>
            <div class="upload-area">
                <input type="file" id="materials-input" accept=".doc,.docx,.xls,.xlsx,.pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/pdf" multiple style="display: none;">
                <label for="materials-input" class="upload-btn">Ch·ªçn File V·∫≠t T∆∞</label>
                <div id="materials-files-list" class="file-status-list"></div>
            </div>
            <button class="upload-btn" id="upload-materials-btn" disabled>T·∫£i V·∫≠t T∆∞ L√™n</button>
            <div class="status-box" id="materials-status" style="display: none;">
                <p class="label">Danh s√°ch URL v·∫≠t t∆∞ (sao ch√©p v√† d√°n v√†o form):</p>
                <textarea id="materials-urls" class="result-textarea" readonly></textarea>
                <button class="copy-btn" data-target="materials-urls">Sao ch√©p</button>
            </div>
        </div>
        
        <div class="nav-link" style="margin-top: 30px;">
            <a href="/dashboard.html">Quay v·ªÅ Dashboard</a>
        </div>
    </div>

    <script>
        /**
         * H√†m ch√≠nh ƒë·ªÉ thi·∫øt l·∫≠p s·ª± ki·ªán v√† logic cho m·ªói khu v·ª±c upload.
         * @param {string} inputId - ID c·ªßa th·∫ª input file
         * @param {string} listId - ID c·ªßa th·∫ª div ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch v√† tr·∫°ng th√°i file
         * @param {string} uploadBtnId - ID c·ªßa n√∫t "T·∫£i L√™n"
         * @param {string} statusBoxId - ID c·ªßa div ch·ª©a k·∫øt qu·∫£ cu·ªëi c√πng
         * @param {string} urlsTextareaId - ID c·ªßa textarea ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch URL
         */
        function setupUploadSection(inputId, listId, uploadBtnId, statusBoxId, urlsTextareaId) {
            const fileInput = document.getElementById(inputId);
            const filesListDiv = document.getElementById(listId);
            const uploadButton = document.getElementById(uploadBtnId);
            const statusBox = document.getElementById(statusBoxId);
            const urlsTextarea = document.getElementById(urlsTextareaId);

            // S·ª± ki·ªán khi ng∆∞·ªùi d√πng ch·ªçn file
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 5) {
                    alert('B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn t·ªëi ƒëa 5 file.');
                    fileInput.value = ''; // X√≥a c√°c file ƒë√£ ch·ªçn
                    return;
                }

                // Hi·ªÉn th·ªã danh s√°ch c√°c file ƒë√£ ch·ªçn
                if (fileInput.files.length > 0) {
                    filesListDiv.innerHTML = Array.from(fileInput.files).map(f => `<div>‚Ä¢ ${f.name} (${(f.size / 1024).toFixed(1)} KB)</div>`).join('');
                    uploadButton.disabled = false;
                } else {
                    filesListDiv.innerHTML = '';
                    uploadButton.disabled = true;
                }
            });

            // S·ª± ki·ªán khi ng∆∞·ªùi d√πng nh·∫•n n√∫t "T·∫£i L√™n"
            uploadButton.addEventListener('click', async () => {
                const files = fileInput.files;
                if (files.length === 0) return;

                uploadButton.disabled = true;
                uploadButton.textContent = 'ƒêang x·ª≠ l√Ω...';
                statusBox.style.display = 'none'; // ·∫®n k·∫øt qu·∫£ c≈©
                urlsTextarea.value = '';

                // GHI CH√ö: N√¢ng c·∫•p ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i cho t·ª´ng file
                filesListDiv.innerHTML = Array.from(files).map(f => `<div id="status-${f.name.replace(/[^a-zA-Z0-9]/g, '')}">${f.name}: ‚è≥ ƒêang ch·ªù...</div>`).join('');

                // N√ÇNG C·∫§P: T·∫£i l√™n t·∫•t c·∫£ c√°c file song song
                const uploadPromises = Array.from(files).map(file => uploadFileToGCS(file, filesListDiv));
                const results = await Promise.all(uploadPromises);
                
                const successfulUrls = results.filter(r => r.success).map(r => r.url);
                
                if (successfulUrls.length > 0) {
                    urlsTextarea.value = successfulUrls.join('\n');
                    statusBox.style.display = 'block';
                }
                
                if (successfulUrls.length === files.length) {
                    alert('T·∫•t c·∫£ file ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n th√†nh c√¥ng!');
                } else {
                    alert('C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh t·∫£i l√™n. Vui l√≤ng ki·ªÉm tra l·∫°i tr·∫°ng th√°i t·ª´ng file.');
                }
                
                uploadButton.textContent = 'T·∫£i L√™n';
                // Kh√¥ng b·∫≠t l·∫°i n√∫t uploadButton.disabled = false; ƒë·ªÉ tr√°nh ng∆∞·ªùi d√πng t·∫£i l·∫°i c√πng m·ªôt b·ªô file.
            });
        }

        /**
         * H√†m th·ª±c hi·ªán quy tr√¨nh t·∫£i 1 file l√™n Google Cloud Storage.
         * @param {File} file - File c·∫ßn t·∫£i l√™n.
         * @param {HTMLElement} statusContainer - Div ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i tr·ª±c quan.
         * @returns {Promise<{success: boolean, url?: string, error?: string}>}
         */
        async function uploadFileToGCS(file, statusContainer) {
            const statusElement = statusContainer.querySelector(`#status-${file.name.replace(/[^a-zA-Z0-9]/g, '')}`);
            
            const updateStatus = (message) => {
                if (statusElement) statusElement.innerHTML = `${file.name}: ${message}`;
            };

            try {
                updateStatus('üîÑ ƒêang l·∫•y link upload t·ª´ server...');
                // B∆∞·ªõc 1: G·ªçi API c·ªßa ch√∫ng ta ƒë·ªÉ l·∫•y Signed URL
                const response = await fetch('/api/generate-upload-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileName: file.name, contentType: file.type || 'application/octet-stream' }),
                });

                if (!response.ok) {
                    let errorMsg = 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server.';
                    try {
                        const err = await response.json();
                        // Ph√¢n t√≠ch l·ªói c·ª• th·ªÉ
                        if (response.status === 401) {
                            errorMsg = 'L·ªói x√°c th·ª±c. B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p?';
                        } else {
                            errorMsg = err.error || errorMsg;
                        }
                    } catch (e) { /* Gi·ªØ l·ªói m·∫∑c ƒë·ªãnh n·∫øu parse JSON th·∫•t b·∫°i */ }
                    throw new Error(errorMsg);
                }
                
                const { uploadUrl, accessUrl } = await response.json();
                
                updateStatus('‚¨ÜÔ∏è ƒêang t·∫£i file l√™n Cloud...');
                // B∆∞·ªõc 2: D√πng Signed URL ƒë·ªÉ t·∫£i th·∫≥ng file l√™n GCS
                const uploadResponse = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': file.type || 'application/octet-stream' },
                    body: file,
                });

                if (!uploadResponse.ok) {
                    throw new Error(`T·∫£i file l√™n Cloud th·∫•t b·∫°i (HTTP ${uploadResponse.status}).`);
                }
                
                updateStatus('‚úî Th√†nh c√¥ng');
                statusElement.classList.add('success');
                return { success: true, url: accessUrl };

            } catch (error) {
                console.error(`L·ªói v·ªõi file ${file.name}:`, error);
                updateStatus(`‚ùå Th·∫•t b·∫°i: ${error.message}`);
                statusElement.classList.add('error');
                return { success: false, error: error.message };
            }
        }

        // Thi·∫øt l·∫≠p cho c·∫£ 3 khu v·ª±c
        setupUploadSection('image-input', 'image-files-list', 'upload-images-btn', 'image-status', 'image-urls');
        setupUploadSection('drawing-input', 'drawing-files-list', 'upload-drawings-btn', 'drawing-status', 'drawing-urls');
        setupUploadSection('materials-input', 'materials-files-list', 'upload-materials-btn', 'materials-status', 'materials-urls');

        // N√ÇNG C·∫§P: S·ª≠ d·ª•ng Clipboard API hi·ªán ƒë·∫°i ƒë·ªÉ sao ch√©p
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.target.dataset.target;
                const textarea = document.getElementById(targetId);
                
                if (navigator.clipboard && window.isSecureContext) {
                    // Ph∆∞∆°ng ph√°p hi·ªán ƒë·∫°i
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        alert('ƒê√£ sao ch√©p danh s√°ch URL!');
                    }).catch(err => {
                        alert('Sao ch√©p th·∫•t b·∫°i!');
                        console.error('L·ªói clipboard:', err);
                    });
                } else {
                    // Ph∆∞∆°ng ph√°p c≈© (fallback)
                    textarea.select();
                    document.execCommand('copy');
                    alert('ƒê√£ sao ch√©p danh s√°ch URL! (ch·∫ø ƒë·ªô c≈©)');
                }
            });
        });
    </script>
</body>
</html>