<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• Upload File</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .container { max-width: 800px; position: relative; }
        .upload-section { margin-bottom: 30px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; background-color: #fdfdfd; }
        .upload-section h3 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 15px; }
        .upload-btn { background-color: #007bff; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: inline-block; transition: background-color 0.2s; }
        .upload-btn:hover { background-color: #0056b3; }
        .upload-btn:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        .status-box { margin-top: 15px; }
        .status-box .label { font-weight: bold; }
        .result-textarea { width: 100%; box-sizing: border-box; height: 120px; font-family: monospace; margin-top: 10px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        .copy-btn { margin-top: 5px; padding: 5px 10px; font-size: 12px; cursor: pointer; }
        .file-status-list { text-align: left; font-size: 14px; margin-top: 10px; }
        .file-status-list div { padding: 4px 0; }
        .file-status-list .success { color: #28a745; }
        .file-status-list .error { color: #dc3545; }

        /* GHI CH√ö: B·ªï sung style cho l·ªõp ph·ªß y√™u c·∫ßu ƒëƒÉng nh·∫≠p */
        #auth-blocker {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border-radius: 8px;
            padding: 20px;
            border: 2px dashed #dc3545;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n ƒëi */
        }
        #auth-blocker h2 { color: #dc3545; }
        #auth-blocker a { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-blocker">
            <h2>Y√™u C·∫ßu ƒêƒÉng Nh·∫≠p</h2>
            <p>B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y.</p>
            <p>Vui l√≤ng <a href="/index.html">ƒëƒÉng nh·∫≠p</a> v√† quay l·∫°i trang n√†y sau.</p>
        </div>

        <header>
            <h1>C√¥ng C·ª• Upload File L√™n Cloud Storage</h1>
            <p>S·ª≠ d·ª•ng trang n√†y ƒë·ªÉ t·∫£i file l√™n v√† sao ch√©p danh s√°ch link ƒë·ªÉ d√°n v√†o form s·∫£n ph·∫©m.</p>
        </header>

        <div class="upload-section">
            <h3>1. H√¨nh ·∫£nh s·∫£n ph·∫©m (T·ªëi ƒëa 5 file)</h3>
            <div class="upload-area">
                <input type="file" id="image-input" accept="image/*" multiple style="display: none;">
                <label for="image-input" class="upload-btn">Ch·ªçn ·∫¢nh</label>
                <div id="image-files-list" class="file-status-list"></div>
            </div>
            <button class="upload-btn" id="upload-images-btn" disabled>T·∫£i ·∫¢nh L√™n</button>
            <div class="status-box" id="image-status" style="display: none;">
                <p class="label">Danh s√°ch URL ·∫£nh (sao ch√©p v√† d√°n v√†o form):</p>
                <textarea id="image-urls" class="result-textarea" readonly></textarea>
                <button class="copy-btn" data-target="image-urls">Sao ch√©p</button>
            </div>
        </div>

        <div class="upload-section">
            <h3>2. B·∫£n v·∫Ω (PDF, T·ªëi ƒëa 5 file)</h3>
            <div class="upload-area">
                <input type="file" id="drawing-input" accept=".pdf" multiple style="display: none;">
                <label for="drawing-input" class="upload-btn">Ch·ªçn File PDF</label>
                <div id="drawing-files-list" class="file-status-list"></div>
            </div>
            <button class="upload-btn" id="upload-drawings-btn" disabled>T·∫£i B·∫£n V·∫Ω L√™n</button>
            <div class="status-box" id="drawing-status" style="display: none;">
                <p class="label">Danh s√°ch URL b·∫£n v·∫Ω (sao ch√©p v√† d√°n v√†o form):</p>
                <textarea id="drawing-urls" class="result-textarea" readonly></textarea>
                <button class="copy-btn" data-target="drawing-urls">Sao ch√©p</button>
            </div>
        </div>

        <div class="upload-section">
            <h3>3. V·∫≠t t∆∞ (Word, Excel, PDF, T·ªëi ƒëa 5 file)</h3>
            <div class="upload-area">
                <input type="file" id="materials-input" accept=".doc,.docx,.xls,.xlsx,.pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/pdf" multiple style="display: none;">
                <label for="materials-input" class="upload-btn">Ch·ªçn File V·∫≠t T∆∞</label>
                <div id="materials-files-list" class="file-status-list"></div>
            </div>
            <button class="upload-btn" id="upload-materials-btn" disabled>T·∫£i V·∫≠t T∆∞ L√™n</button>
            <div class="status-box" id="materials-status" style="display: none;">
                <p class="label">Danh s√°ch URL v·∫≠t t∆∞ (sao ch√©p v√† d√°n v√†o form):</p>
                <textarea id="materials-urls" class="result-textarea" readonly></textarea>
                <button class="copy-btn" data-target="materials-urls">Sao ch√©p</button>
            </div>
        </div>
        
        <div class="nav-link" style="margin-top: 30px;">
            <a href="/dashboard.html">Quay v·ªÅ Dashboard</a>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const authBlocker = document.getElementById('auth-blocker');

        // GHI CH√ö: B∆∞·ªõc quan tr·ªçng nh·∫•t - Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        fetch('/api/me')
            .then(response => {
                if (!response.ok) {
                    // N·∫øu kh√¥ng OK (l·ªói 401, 500, etc.), nghƒ©a l√† ch∆∞a ƒëƒÉng nh·∫≠p
                    throw new Error('User not authenticated');
                }
                // N·∫øu OK, ti·∫øp t·ª•c ch·∫°y code c·ªßa trang
                initializeUploadPage();
            })
            .catch(error => {
                // N·∫øu c√≥ l·ªói (ch∆∞a ƒëƒÉng nh·∫≠p), hi·ªÉn th·ªã l·ªõp ph·ªß v√† kh√≥a trang
                console.error(error.message);
                authBlocker.style.display = 'flex';
            });
    });

    /**
     * H√†m n√†y ch·ªâ ƒë∆∞·ª£c g·ªçi sau khi ƒë√£ x√°c th·ª±c ng∆∞·ªùi d√πng th√†nh c√¥ng.
     */
    function initializeUploadPage() {
        /**
         * H√†m ch√≠nh ƒë·ªÉ thi·∫øt l·∫≠p s·ª± ki·ªán v√† logic cho m·ªói khu v·ª±c upload.
         */
        function setupUploadSection(inputId, listId, uploadBtnId, statusBoxId, urlsTextareaId) {
            const fileInput = document.getElementById(inputId);
            const filesListDiv = document.getElementById(listId);
            const uploadButton = document.getElementById(uploadBtnId);
            const statusBox = document.getElementById(statusBoxId);
            const urlsTextarea = document.getElementById(urlsTextareaId);

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 5) {
                    alert('B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªçn t·ªëi ƒëa 5 file.');
                    fileInput.value = '';
                    return;
                }
                if (fileInput.files.length > 0) {
                    filesListDiv.innerHTML = Array.from(fileInput.files).map(f => `<div>‚Ä¢ ${f.name} (${(f.size / 1024).toFixed(1)} KB)</div>`).join('');
                    uploadButton.disabled = false;
                } else {
                    filesListDiv.innerHTML = '';
                    uploadButton.disabled = true;
                }
            });

            uploadButton.addEventListener('click', async () => {
                const files = fileInput.files;
                if (files.length === 0) return;

                uploadButton.disabled = true;
                uploadButton.textContent = 'ƒêang x·ª≠ l√Ω...';
                statusBox.style.display = 'none';
                urlsTextarea.value = '';

                filesListDiv.innerHTML = Array.from(files).map(f => `<div id="status-${f.name.replace(/[^a-zA-Z0-9]/g, '')}">${f.name}: ‚è≥ ƒêang ch·ªù...</div>`).join('');

                const uploadPromises = Array.from(files).map(file => uploadFileToGCS(file, filesListDiv));
                const results = await Promise.all(uploadPromises);
                
                const successfulUrls = results.filter(r => r.success).map(r => r.url);
                
                if (successfulUrls.length > 0) {
                    urlsTextarea.value = successfulUrls.join('\n');
                    statusBox.style.display = 'block';
                }
                
                if (successfulUrls.length === files.length) {
                    alert('T·∫•t c·∫£ file ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n th√†nh c√¥ng!');
                } else {
                    alert('C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh t·∫£i l√™n. Vui l√≤ng ki·ªÉm tra l·∫°i tr·∫°ng th√°i t·ª´ng file.');
                }
                
                uploadButton.textContent = 'T·∫£i L√™n';
            });
        }

        /**
         * H√†m th·ª±c hi·ªán quy tr√¨nh t·∫£i 1 file l√™n Google Cloud Storage.
         */
        async function uploadFileToGCS(file, statusContainer) {
            const statusElement = statusContainer.querySelector(`#status-${file.name.replace(/[^a-zA-Z0-9]/g, '')}`);
            
            const updateStatus = (message) => {
                if (statusElement) statusElement.innerHTML = `${file.name}: ${message}`;
            };

            try {
                updateStatus('üîÑ ƒêang l·∫•y link upload t·ª´ server...');
                const response = await fetch('/api/generate-upload-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileName: file.name, contentType: file.type || 'application/octet-stream' }),
                });

                if (!response.ok) {
                    let errorMsg = 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server.';
                    if (response.status === 401) errorMsg = 'L·ªói x√°c th·ª±c. Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n?';
                    else {
                        try {
                           const err = await response.json();
                           errorMsg = err.error || errorMsg;
                        } catch(e) {}
                    }
                    throw new Error(errorMsg);
                }
                
                const { uploadUrl, accessUrl } = await response.json();
                
                updateStatus('‚¨ÜÔ∏è ƒêang t·∫£i file l√™n Cloud...');
                const uploadResponse = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': file.type || 'application/octet-stream' },
                    body: file,
                });

                if (!uploadResponse.ok) {
                    throw new Error(`T·∫£i file l√™n Cloud th·∫•t b·∫°i (HTTP ${uploadResponse.status}).`);
                }
                
                updateStatus('‚úî Th√†nh c√¥ng');
                statusElement.classList.add('success');
                return { success: true, url: accessUrl };

            } catch (error) {
                console.error(`L·ªói v·ªõi file ${file.name}:`, error);
                updateStatus(`‚ùå Th·∫•t b·∫°i: ${error.message}`);
                statusElement.classList.add('error');
                return { success: false, error: error.message };
            }
        }

        // Thi·∫øt l·∫≠p cho c·∫£ 3 khu v·ª±c
        setupUploadSection('image-input', 'image-files-list', 'upload-images-btn', 'image-status', 'image-urls');
        setupUploadSection('drawing-input', 'drawing-files-list', 'upload-drawings-btn', 'drawing-status', 'drawing-urls');
        setupUploadSection('materials-input', 'materials-files-list', 'upload-materials-btn', 'materials-status', 'materials-urls');

        // G·∫Øn s·ª± ki·ªán cho c√°c n√∫t sao ch√©p
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.target.dataset.target;
                const textarea = document.getElementById(targetId);
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        alert('ƒê√£ sao ch√©p danh s√°ch URL!');
                    }).catch(err => {
                        alert('Sao ch√©p th·∫•t b·∫°i!');
                        console.error('L·ªói clipboard:', err);
                    });
                } else {
                    textarea.select();
                    document.execCommand('copy');
                    alert('ƒê√£ sao ch√©p danh s√°ch URL!');
                }
            });
        });
    }
    </script>
</body>
</html>