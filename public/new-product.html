<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm Sản Phẩm Mới</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /*
         * CSS Nâng Cao Cho Trải Nghiệm Người Dùng Tốt Hơn
         * Khi nút submit bị vô hiệu hóa (trong lúc đang gửi form),
         * nó sẽ đổi màu và con trỏ chuột để người dùng biết không thể click được nữa.
         */
        button[type="submit"]:disabled {
            background-color: #5a6268; /* Một màu xám đậm hơn */
            border-color: #5a6268;
            cursor: not-allowed;      /* Biểu tượng con trỏ chuột "cấm" */
            opacity: 0.65;            /* Làm mờ nút đi một chút */
        }
        /* Style cho phần hiển thị trạng thái upload */
        .upload-status {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9f7fe;
            border-left: 4px solid #007bff;
            font-style: italic;
            color: #333;
            display: none; /* Mặc định sẽ ẩn đi */
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Thêm Sản Phẩm Mới / Add New Product</h1>
            <p>Điền đầy đủ các thông tin dưới đây và nhấn "Lưu" để tạo sản phẩm mới.</p>
        </header>

        <!-- Phần form HTML của bạn được giữ nguyên. Thuộc tính enctype không còn cần thiết
             vì chúng ta không gửi form theo cách truyền thống nữa, nhưng giữ lại cũng không sao. -->
        <form id="product-form">
            
            <div class="form-section">
                <h2>Thông Tin Chung</h2>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="product-id-suffix">Mã Sản Phẩm / Product ID (Bắt buộc 11 ký tự sau "KT")</label>
                        <div class="id-prefix">
                            <span>KT</span>
                            <input type="text" id="product-id-suffix" required maxlength="11" pattern=".{11,11}" title="Vui lòng nhập đúng 11 ký tự.">
                            <input type="hidden" name="id" id="full-product-id">
                        </div>
                    </div>
                    <div class="form-group"><label for="name_vi">Tên Sản Phẩm (VI)</label><input type="text" id="name_vi" name="name_vi" required></div>
                    <div class="form-group"><label for="name_en">Product Name (EN)</label><input type="text" id="name_en" name="name_en" required></div>
                    <div class="form-group"><label for="parent_id">Mã Sản Phẩm Gốc (Nếu có)</label><input type="text" id="parent_id" name="parent_id" placeholder="Ví dụ: KT25LVSSF0001"></div>
                    <div class="form-group"><label for="collection_vi">Bộ Sưu Tập (VI)</label><input type="text" id="collection_vi" name="collection_vi"></div>
                    <div class="form-group"><label for="collection_en">Collection (EN)</label><input type="text" id="collection_en" name="collection_en"></div>
                </div>
            </div>

            <div class="form-section">
                <h2>Chi Tiết Vật Liệu & Sản Xuất</h2>
                <div class="form-grid">
                    <div class="form-group"><label for="color_vi">Màu sắc (VI)</label><input type="text" id="color_vi" name="color_vi"></div>
                    <div class="form-group"><label for="color_en">Color (EN)</label><input type="text" id="color_en" name="color_en"></div>
                    <div class="form-group"><label for="fabric_vi">Vải (VI)</label><input type="text" id="fabric_vi" name="fabric_vi"></div>
                    <div class="form-group"><label for="fabric_en">Fabric (EN)</label><input type="text" id="fabric_en" name="fabric_en"></div>
                    <div class="form-group"><label for="wicker_vi">Dây (VI)</label><input type="text" id="wicker_vi" name="wicker_vi"></div>
                    <div class="form-group"><label for="wicker_en">Wicker (EN)</label><input type="text" id="wicker_en" name="wicker_en"></div>
                    <div class="form-group"><label for="material_vi">Chất liệu (VI)</label><input type="text" id="material_vi" name="material_vi"></div>
                    <div class="form-group"><label for="material_en">Material (EN)</label><input type="text" id="material_en" name="material_en"></div>
                    <div class="form-group"><label for="supplier">Nhà cung cấp</label><input type="text" id="supplier" name="supplier"></div>
                    <div class="form-group full-width"><label for="aluminum_profile">Biên dạng nhôm</label><input type="text" id="aluminum_profile" name="aluminum_profile"></div>
                    <div class="form-group">
                        <label for="production_place">Nơi sản xuất</label>
                        <select id="production_place" name="production_place">
                            <option value="KT">KT</option>
                            <option value="Minh Tien">Minh Tiến</option>
                            <option value="Other">Khác</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
    <h2>Tệp Đính Kèm</h2>
    <p style="font-style: italic; margin-bottom: 15px;">
        Sử dụng <a href="/upload.html" target="_blank">Công cụ Upload</a> để tải file lên và dán danh sách link vào các ô dưới đây.
    </p>
    <div class="form-group full-width">
        <label for="imageUrls">Danh sách URL Hình ảnh sản phẩm (mỗi link một dòng)</label>
        <textarea id="imageUrls" name="imageUrls" rows="5" placeholder="Dán danh sách link ảnh từ trang Upload vào đây..."></textarea>
    </div>
    <div class="form-group full-width">
        <label for="drawingUrls">Danh sách URL Bản vẽ (PDF)</label>
        <textarea id="drawingUrls" name="drawingUrls" rows="5" placeholder="Dán danh sách link bản vẽ từ trang Upload vào đây..."></textarea>
    </div>
    <div class="form-group full-width">
        <label for="materialsUrls">Danh sách URL Vật tư</label>
        <textarea id="materialsUrls" name="materialsUrls" rows="5" placeholder="Dán danh sách link vật tư từ trang Upload vào đây..."></textarea>
    </div>
</div>
            
            <div class="form-actions">
                <button type="submit" id="submit-button">Lưu và Xem lại</button>
                <!-- Thêm một div để hiển thị trạng thái upload cho người dùng -->
                <div class="upload-status" id="upload-status"></div>
            </div>
        </form>
        
        <div class="nav-link">
            <a href="/product-list.html">Quay về danh sách sản phẩm</a>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- === PHẦN JAVASCRIPT XỬ LÝ UPLOAD LÊN GCS (HOÀN TOÀN MỚI) === -->
    <!-- =================================================================== -->
    <script>
    // Áp dụng cho cả 'product-form' và 'edit-form'
    const form = document.querySelector('form'); 
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Đang lưu...';

        try {
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            // Xử lý ID cho form tạo mới
            if (form.id === 'product-form') {
                const idSuffixInput = document.getElementById('product-id-suffix');
                data.id = 'KT' + idSuffixInput.value;
            }

            // Chuyển đổi chuỗi từ textarea thành mảng
            data.imageUrls = (data.imageUrls || '').split('\n').filter(link => link.trim() !== '');
            data.drawingUrls = (data.drawingUrls || '').split('\n').filter(link => link.trim() !== '');
            data.materialsUrls = (data.materialsUrls || '').split('\n').filter(link => link.trim() !== '');

            // Xác định phương thức và URL
            const isEditing = form.id === 'edit-form';
            const url = isEditing ? `/api/products/${data.id}` : '/api/products';
            const method = isEditing ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            
            alert(result.message || 'Thao tác thành công!');
            window.location.href = isEditing ? '/product-list.html' : `/success.html?id=${result.id}`;

        } catch (error) {
            alert('Có lỗi xảy ra: ' + error.message);
            submitButton.disabled = false;
            submitButton.textContent = isEditing ? 'Lưu Thay Đổi' : 'Lưu và Xem lại';
        }
    });

    // Logic riêng để tải dữ liệu cho trang edit
    if (form.id === 'edit-form') {
        // ... (phần document.addEventListener('DOMContentLoaded', ...) để tải dữ liệu cũ vào form)
    }
</script>



</body>
</html>
