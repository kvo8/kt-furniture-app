<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm Sản Phẩm Mới</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /*
         * CSS Nâng Cao Cho Trải Nghiệm Người Dùng Tốt Hơn
         * Khi nút submit bị vô hiệu hóa (trong lúc đang gửi form),
         * nó sẽ đổi màu và con trỏ chuột để người dùng biết không thể click được nữa.
         */
        button[type="submit"]:disabled {
            background-color: #5a6268; /* Một màu xám đậm hơn */
            border-color: #5a6268;
            cursor: not-allowed;      /* Biểu tượng con trỏ chuột "cấm" */
            opacity: 0.65;            /* Làm mờ nút đi một chút */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Thêm Sản Phẩm Mới / Add New Product</h1>
            <p>Điền đầy đủ các thông tin dưới đây và nhấn "Lưu" để tạo sản phẩm mới.</p>
        </header>

        <form id="product-form" enctype="multipart/form-data">
            
            <!-- =================================================================== -->
            <!-- === CÁC TRƯỜNG THÔNG TIN SẢN PHẨM (PHẦN NÀY ĐÃ CHUẨN) === -->
            <!-- =================================================================== -->

            <div class="form-section">
                <h2>Thông Tin Chung</h2>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="product-id-suffix">Mã Sản Phẩm / Product ID (Bắt buộc 11 ký tự sau "KT")</label>
                        <div class="id-prefix">
                            <span>KT</span>
                            <input type="text" id="product-id-suffix" required maxlength="11" pattern=".{11,11}" title="Vui lòng nhập đúng 11 ký tự.">
                            <input type="hidden" name="id" id="full-product-id">
                        </div>
                    </div>
                    <div class="form-group"><label for="name_vi">Tên Sản Phẩm (VI)</label><input type="text" id="name_vi" name="name_vi" required></div>
                    <div class="form-group"><label for="name_en">Product Name (EN)</label><input type="text" id="name_en" name="name_en" required></div>
                    <div class="form-group"><label for="parent_id">Mã Sản Phẩm Gốc (Nếu có)</label><input type="text" id="parent_id" name="parent_id" placeholder="Ví dụ: KT25LVSSF0001"></div>
                    <div class="form-group"><label for="collection_vi">Bộ Sưu Tập (VI)</label><input type="text" id="collection_vi" name="collection_vi"></div>
                    <div class="form-group"><label for="collection_en">Collection (EN)</label><input type="text" id="collection_en" name="collection_en"></div>
                </div>
            </div>

            <div class="form-section">
                <h2>Chi Tiết Vật Liệu & Sản Xuất</h2>
                <div class="form-grid">
                    <div class="form-group"><label for="color_vi">Màu sắc (VI)</label><input type="text" id="color_vi" name="color_vi"></div>
                    <div class="form-group"><label for="color_en">Color (EN)</label><input type="text" id="color_en" name="color_en"></div>
                    <div class="form-group"><label for="fabric_vi">Vải (VI)</label><input type="text" id="fabric_vi" name="fabric_vi"></div>
                    <div class="form-group"><label for="fabric_en">Fabric (EN)</label><input type="text" id="fabric_en" name="fabric_en"></div>
                    <div class="form-group"><label for="wicker_vi">Dây (VI)</label><input type="text" id="wicker_vi" name="wicker_vi"></div>
                    <div class="form-group"><label for="wicker_en">Wicker (EN)</label><input type="text" id="wicker_en" name="wicker_en"></div>
                    <div class="form-group"><label for="material_vi">Chất liệu (VI)</label><input type="text" id="material_vi" name="material_vi"></div>
                    <div class="form-group"><label for="material_en">Material (EN)</label><input type="text" id="material_en" name="material_en"></div>
                    <div class="form-group full-width"><label for="aluminum_profile">Biên dạng nhôm</label><input type="text" id="aluminum_profile" name="aluminum_profile"></div>
                    <div class="form-group">
                        <label for="production_place">Nơi sản xuất</label>
                        <select id="production_place" name="production_place">
                            <option value="KT">KT</option>
                            <option value="Minh Tien">Minh Tiến</option>
                            <option value="Other">Khác</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>Thông Tin Thương Mại & Kỹ Thuật</h2>
                <div class="form-grid">
                     <div class="form-group"><label for="company">Công ty</label><input type="text" id="company" name="company"></div>
                     <div class="form-group"><label for="customer">Khách hàng</label><input type="text" id="customer" name="customer"></div>
                     <div class="form-group full-width"><label for="specification">Thông số</label><input type="text" id="specification" name="specification"></div>
                     <div class="form-group full-width"><label for="other_details">Chi tiết khác</label><textarea id="other_details" name="other_details" rows="3"></textarea></div>
                </div>
            </div>
            
            <div class="form-section">
                <h2>Tệp Đính Kèm</h2>
                <div class="form-grid">
                    <div class="form-group full-width"><label for="productImage">Hình ảnh sản phẩm</label><input type="file" id="productImage" name="productImage" accept="image/*"></div>
                    <div class="form-group full-width"><label for="drawingFile">Bản vẽ (PDF)</label><input type="file" id="drawingFile" name="drawingFile" accept=".pdf"></div>
                    <div class="form-group full-width"><label for="materialsFile">Vật tư (Word, Excel, PDF)</label><input type="file" id="materialsFile" name="materialsFile" accept=".doc,.docx,.xls,.xlsx,.pdf"></div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" id="submit-button">Lưu và Xem lại</button>
            </div>
        </form>
        
        <div class="nav-link">
            <a href="/product-list.html">Quay về danh sách sản phẩm</a>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- === PHẦN JAVASCRIPT XỬ LÝ FORM (ĐÃ TỐI ƯU VÀ CHÚ THÍCH KỸ) === -->
    <!-- =================================================================== -->
    <script>
        // Lấy các element quan trọng của form và lưu vào biến để dễ dàng truy cập.
        // Đây là một good practice trong lập trình JavaScript.
        const form = document.getElementById('product-form');
        const idSuffixInput = document.getElementById('product-id-suffix');
        const fullIdInput = document.getElementById('full-product-id');
        const submitButton = document.getElementById('submit-button');

        // Gán một hàm xử lý sự kiện 'submit' cho form.
        // Dùng 'async' để có thể sử dụng 'await' bên trong, giúp code gọn gàng hơn.
        form.addEventListener('submit', async function(event) {
            // Ngăn hành vi mặc định của form là tải lại trang khi nhấn submit.
            // Chúng ta sẽ xử lý việc gửi dữ liệu bằng JavaScript.
            event.preventDefault();
            
            // --- BƯỚC 1: VÔ HIỆU HÓA NÚT VÀ HIỂN THỊ TRẠNG THÁI "ĐANG GỬI" ---
            // Điều này ngăn người dùng click nhiều lần gây ra lỗi và cho họ biết hệ thống đang xử lý.
            submitButton.disabled = true;
            submitButton.textContent = 'Đang xử lý, vui lòng chờ...';

            // --- BƯỚC 2: CHUẨN BỊ DỮ LIỆU FORM ---
            // Tự động ghép chuỗi "KT" vào mã sản phẩm từ ô input.
            fullIdInput.value = 'KT' + idSuffixInput.value;
            
            // Tạo một đối tượng FormData từ chính form này.
            // FormData là cách chuẩn để đóng gói dữ liệu form, bao gồm cả file, để gửi đi.
            const formData = new FormData(this);

            // --- BƯỚC 3: GỬI DỮ LIỆU VÀ XỬ LÝ KẾT QUẢ ---
            // Bọc toàn bộ logic gửi request trong một khối try...catch để bắt lỗi một cách an toàn.
            try {
                // Gửi dữ liệu đến API endpoint '/api/products' bằng phương thức POST.
                // 'await' sẽ tạm dừng hàm cho đến khi có phản hồi từ server.
                const response = await fetch('/api/products', {
                    method: 'POST',
                    body: formData, // Nội dung gửi đi chính là gói FormData đã tạo.
                });

                // Xử lý phản hồi từ server.
                // 'response.ok' sẽ là 'false' nếu mã trạng thái là lỗi (ví dụ 404, 500, 413).
                if (!response.ok) {
                    // Nếu server trả về lỗi, chúng ta cần tìm hiểu đó là lỗi gì.
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        // Nếu lỗi được trả về dưới dạng JSON (do chúng ta lập trình trong index.js)
                        const errorResult = await response.json();
                        // Ném ra một lỗi mới với thông điệp từ server.
                        throw new Error(errorResult.error || 'Lỗi không xác định từ server');
                    } else {
                        // Nếu lỗi là HTML (thường là do server bị lỗi 413 hoặc lỗi nghiêm trọng khác)
                        if (response.status === 413) {
                            // Đưa ra thông báo lỗi thân thiện và cụ thể cho lỗi 413.
                            throw new Error(`Lỗi từ server (mã 413): Tệp quá lớn! Vui lòng kiểm tra lại kích thước file.`);
                        }
                        // Với các lỗi HTML khác, hiển thị mã lỗi và một phần nội dung.
                        const errorText = await response.text();
                        throw new Error(`Lỗi từ server (mã ${response.status}): ${errorText.substring(0, 200)}`);
                    }
                }

                // Nếu không có lỗi, xử lý kết quả thành công.
                const result = await response.json();
                if (result.error) {
                    // Xử lý trường hợp server trả về 200 OK nhưng vẫn có message lỗi trong JSON.
                    throw new Error(result.error);
                }
                
                // Nếu mọi thứ thành công, chuyển hướng người dùng đến trang success.html
                // kèm theo ID của sản phẩm vừa tạo để hiển thị lại thông tin.
                window.location.href = `/success.html?id=${result.id}`;

            } catch (error) {
                // Khối catch này sẽ bắt tất cả các lỗi được 'throw' ở trên.
                // Hiển thị một thông báo alert cho người dùng.
                alert('Có lỗi xảy ra: ' + error.message);
                
                // --- BƯỚC 4: KÍCH HOẠT LẠI NÚT NẾU CÓ LỖI ---
                // Cho phép người dùng thử lại sau khi đã đọc thông báo lỗi.
                submitButton.disabled = false;
                submitButton.textContent = 'Lưu và Xem lại';
            }
        });
    </script>
</body>
</html>
