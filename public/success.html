<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√™m S·∫£n Ph·∫©m Th√†nh C√¥ng</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body { background-color: #f4f7f6; }
        .success-container { text-align: center; }
        .success-container h1 { color: #28a745; font-size: 2em; }
        .success-container h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .success-container h3 { color: #555; margin-top: 30px; }
        
        #product-review { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.07); }
        .product-details {
            display: grid;
            grid-template-columns: 1fr; /* 1 c·ªôt tr√™n m√†n h√¨nh nh·ªè */
            gap: 15px;
            text-align: left;
            margin-top: 20px;
            padding-top: 20px;
        }
        @media (min-width: 768px) {
            .product-details {
                grid-template-columns: 1fr 1fr; /* 2 c·ªôt tr√™n m√†n h√¨nh l·ªõn */
            }
        }
        .detail-item {
            padding: 10px;
            background-color: #f9f9f9;
            border-left: 3px solid #007bff;
            border-radius: 4px;
        }
        .detail-item strong {
            display: block;
            margin-bottom: 5px;
            color: #343a40;
        }
        .detail-item ul { list-style: none; padding-left: 0; margin: 0; }
        .detail-item ul li a { word-break: break-all; }

        #qrcode-image { margin-top: 15px; border: 1px solid #ccc; padding: 10px; display: inline-block; background-color: #fff; }
        
        .action-buttons { margin-top: 40px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .action-buttons a {
            text-decoration: none;
            display: inline-block;
            padding: 12px 25px;
            color: white;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .action-buttons a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .add-more-btn { background-color: #007bff; }
        .view-list-btn { background-color: #6c757d; }
        .view-public-btn { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container success-container">
        <h1 id="status-message">‚è≥ ƒêang t·∫£i th√¥ng tin s·∫£n ph·∫©m...</h1>
        
        <div id="product-review" style="display: none;">
            <h2>Xem l·∫°i th√¥ng tin s·∫£n ph·∫©m v·ª´a t·∫°o</h2>
            <div id="details-content" class="product-details">
                </div>
            
            <h3>M√£ QR Code</h3>
            <div id="qrcode-image"></div>
            <p><i>(Qu√©t m√£ n√†y ƒë·ªÉ xem trang c√¥ng khai c·ªßa s·∫£n ph·∫©m)</i></p>
        </div>

        <div class="action-buttons">
            <a href="/new-product.html" class="add-more-btn">Th√™m s·∫£n ph·∫©m kh√°c</a>
            <a href="/product-list.html" class="view-list-btn">Xem danh s√°ch s·∫£n ph·∫©m</a>
            </div>
    </div>

    <script>
    /**
     * GHI CH√ö: File n√†y ƒë∆∞·ª£c th·ª±c thi sau khi t·∫°o s·∫£n ph·∫©m th√†nh c√¥ng.
     * M·ª•c ti√™u: L·∫•y l·∫°i d·ªØ li·ªáu v·ª´a t·∫°o t·ª´ server, hi·ªÉn th·ªã m·ªôt c√°ch r√µ r√†ng,
     * v√† cung c·∫•p m√£ QR c≈©ng nh∆∞ c√°c l·ª±a ch·ªçn ƒëi·ªÅu h∆∞·ªõng cho ng∆∞·ªùi d√πng.
     */
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        const statusMessage = document.getElementById('status-message');
        const productReviewDiv = document.getElementById('product-review');
        const detailsDiv = document.getElementById('details-content');
        const qrCodeDiv = document.getElementById('qrcode-image');

        if (!productId) {
            statusMessage.textContent = '‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m trong URL.';
            statusMessage.style.color = '#dc3545';
            return;
        }

        statusMessage.textContent = `üéâ Th√™m s·∫£n ph·∫©m ${productId} th√†nh c√¥ng!`;
        productReviewDiv.style.display = 'block'; // Hi·ªÉn th·ªã khu v·ª±c review

        // --- N√ÇNG C·∫§P: ƒê·ªãnh nghƒ©a nh√£n v√† th·ª© t·ª± hi·ªÉn th·ªã cho ƒë·∫πp ---
        const fieldLabels = {
            name_vi: "T√™n S·∫£n Ph·∫©m (VI)",
            name_en: "Product Name (EN)",
            collection_vi: "B·ªô S∆∞u T·∫≠p (VI)",
            collection_en: "Collection (EN)",
            color_vi: "M√†u s·∫Øc (VI)",
            color_en: "Color (EN)",
            fabric_vi: "V·∫£i (VI)",
            fabric_en: "Fabric (EN)",
            wicker_vi: "D√¢y (VI)",
            wicker_en: "Wicker (EN)",
            material_vi: "Ch·∫•t li·ªáu (VI)",
            material_en: "Material (EN)",
            specification: "Th√¥ng s·ªë",
            aluminum_profile: "Bi√™n d·∫°ng nh√¥m",
            supplier: "Nh√† cung c·∫•p",
            production_place: "N∆°i s·∫£n xu·∫•t",
            company: "C√¥ng ty",
            customer: "Kh√°ch h√†ng",
            other_details: "Chi ti·∫øt kh√°c",
            created_by_name: "Ng∆∞·ªùi t·∫°o",
            parent_id: "M√£ S·∫£n Ph·∫©m G·ªëc",
            imageUrls: "Danh s√°ch URL H√¨nh ·∫£nh",
            drawingUrls: "Danh s√°ch URL B·∫£n v·∫Ω",
            materialsUrls: "Danh s√°ch URL V·∫≠t t∆∞"
        };
        
        // M·∫£ng n√†y quy·∫øt ƒë·ªãnh tr∆∞·ªùng n√†o ƒë∆∞·ª£c hi·ªÉn th·ªã v√† theo th·ª© t·ª± n√†o
        const displayOrder = [
            'name_vi', 'name_en', 'collection_vi', 'collection_en', 'color_vi', 'color_en',
            'material_vi', 'material_en', 'fabric_vi', 'fabric_en', 'wicker_vi', 'wicker_en',
            'specification', 'aluminum_profile', 'supplier', 'production_place', 'company', 
            'customer', 'other_details', 'created_by_name', 'parent_id',
            'imageUrls', 'drawingUrls', 'materialsUrls'
        ];

        // G·ªçi API ƒë·ªÉ l·∫•y l·∫°i th√¥ng tin chi ti·∫øt c·ªßa s·∫£n ph·∫©m v·ª´a t·∫°o
        fetch(`/api/products/${productId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`L·ªói t·ª´ server: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(product => {
                if (!product || product.error) {
                    throw new Error(product.error || 'Kh√¥ng th·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu s·∫£n ph·∫©m.');
                }

                // --- N√ÇNG C·∫§P: V√≤ng l·∫∑p hi·ªÉn th·ªã d·ªØ li·ªáu c√≥ c·∫•u tr√∫c ---
                detailsDiv.innerHTML = ''; // X√≥a n·ªôi dung c≈©
                
                displayOrder.forEach(key => {
                    const value = product[key];
                    // Ch·ªâ hi·ªÉn th·ªã n·∫øu tr∆∞·ªùng ƒë√≥ c√≥ gi√° tr·ªã
                    if (value && (typeof value !== 'object' || Array.isArray(value) && value.length > 0)) {
                        const label = fieldLabels[key] || key;
                        const detailItem = document.createElement('div');
                        detailItem.className = 'detail-item';

                        let contentHTML = `<strong>${label}:</strong>`;

                        // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho c√°c tr∆∞·ªùng ch·ª©a URL
                        if (['imageUrls', 'drawingUrls', 'materialsUrls'].includes(key)) {
                            contentHTML += '<ul>';
                            // `product[key]` ƒë√£ ƒë∆∞·ª£c server parse s·∫µn th√†nh array
                            value.forEach(item => {
                                const url = typeof item === 'object' ? item.url : item;
                                const name = typeof item === 'object' ? item.name : url.split('/').pop();
                                contentHTML += `<li><a href="${url}" target="_blank" rel="noopener noreferrer">${name}</a></li>`;
                            });
                            contentHTML += '</ul>';
                        } else {
                            contentHTML += `<span>${value}</span>`;
                        }
                        
                        detailItem.innerHTML = contentHTML;
                        detailsDiv.appendChild(detailItem);
                    }
                });


                // T·∫°o v√† hi·ªÉn th·ªã m√£ QR
                const publicUrl = `${window.location.origin}/product-view.html?id=${productId}`;
                const qr = qrcode(0, 'H');
                qr.addData(publicUrl);
                qr.make();
                qrCodeDiv.innerHTML = qr.createImgTag(8, 10);

                // Th√™m n√∫t "Xem trang c√¥ng khai"
                const viewPublicBtn = document.createElement('a');
                viewPublicBtn.href = publicUrl;
                viewPublicBtn.target = "_blank"; // M·ªü trong tab m·ªõi
                viewPublicBtn.className = 'view-public-btn';
                viewPublicBtn.textContent = 'Xem Trang C√¥ng Khai';
                document.querySelector('.action-buttons').appendChild(viewPublicBtn);

            })
            .catch(error => {
                console.error('L·ªói khi t·∫£i chi ti·∫øt s·∫£n ph·∫©m:', error);
                productReviewDiv.innerHTML = `<h2 style="color: #dc3545;">L·ªói khi t·∫£i d·ªØ li·ªáu xem tr∆∞·ªõc</h2><p>${error.message}</p>`;
            });
    });
    </script>
</body>
</html>